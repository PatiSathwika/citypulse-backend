<!DOCTYPE html>
<html lang="en">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - CityPulse</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-gray-100 backdrop-blur-sm fixed w-full top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="flex items-center space-x-3 cursor-pointer" onclick="window.location.href='/'">
                    <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold text-gray-800">CityPulse</span>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/user" class="text-blue-600 font-medium">Dashboard</a>
                    <a href="#" class="text-gray-700 hover:text-blue-600 transition font-medium">My Reports</a>
                    <button onclick="logout()" class="px-6 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">
                        Logout
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <button onclick="toggleMobileMenu()" class="md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t">
            <div class="px-4 py-4 space-y-3">
                <a href="user-dashboard.html" class="block px-4 py-2 rounded-lg bg-blue-50 text-blue-600 font-medium">Dashboard</a>
                <a href="#" class="block px-4 py-2 rounded-lg hover:bg-gray-100 font-medium">My Reports</a>
                <button onclick="logout()" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg font-medium">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="pt-28 pb-16 px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Page Title -->
            <h1 class="text-4xl font-bold mb-8 text-gray-900">My Dashboard</h1>

            <!-- Report Form Section -->
            <div class="bg-white rounded-2xl shadow-sm p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-900">Report New Issue</h2>
                
                <form id="reportForm" class="grid md:grid-cols-2 gap-6">
                    <!-- Issue Type Dropdown -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Issue Type</label>
                        <select id="issueType" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none">
                            <option value="">Select Issue</option>
<option value="pothole">üï≥Ô∏è Pothole</option>
<option value="garbage">üóëÔ∏è Garbage Overflow</option>
<option value="streetlight">üí° Broken Streetlight</option>
<option value="water">üíß Water Leakage</option>
<option value="others">üìù Others</option>

                        </select>
                    </div>
<div id="otherIssueBox" class="hidden mt-4">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        Please specify the issue
    </label>
    <input type="text"
           id="otherIssueText"
           placeholder="Describe the issue type"
           class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-200">
</div>

                    <!-- Location Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" id="location" placeholder="Enter location" required
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none">
                    </div>

                    <!-- Description Textarea -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="description" placeholder="Describe the issue..." rows="3" required
                                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"></textarea>
                    </div>
                    <!-- Photo Upload Area -->
<div class="md:col-span-2">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        Upload Photo
    </label>

    <!-- Upload Box -->
    <div id="dropArea"
         class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center
                hover:border-blue-500 transition cursor-pointer">

        <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none"
             stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9
                     M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>

        <p class="text-gray-600">
            Click to upload or drag and drop
        </p>
        <p class="text-gray-500 text-sm mt-1">
            PNG, JPG up to 10MB
        </p>

        <!-- Hidden File Input -->
        <input type="file"
               id="photoInput"
               accept="image/*"
               class="hidden">
    </div>

    <!-- Image Preview -->
    <img id="previewImage"
         class="hidden mt-4 w-32 h-32 object-cover rounded-lg border">
</div>




                </form>

                <!-- Submit Button -->
                <button onclick="submitReport()" class="mt-6 w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                    Submit Report
                </button>
            </div>
          <!-- My Reports Section -->
<div class="bg-white rounded-2xl shadow-sm p-8">
    <h2 class="text-2xl font-bold mb-6 text-gray-900">My Reports</h2>

    <div id="myReports" class="space-y-4">
        <!-- REAL DATA WILL LOAD HERE -->
    </div>
</div>

        </div>
    </div>

    <!-- JavaScript Functions -->
     <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAITsuAE_mdaB00MDUK1O6LEwASk-iSAf0",
  authDomain: "citypulse-b6c5e.firebaseapp.com",
  projectId: "citypulse-b6c5e",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "/login";
  }
});
</script>

     <script>
        document.getElementById("issueType").addEventListener("change", function () {
    const otherBox = document.getElementById("otherIssueBox");
    if (this.value === "others") {
        otherBox.classList.remove("hidden");
    } else {
        otherBox.classList.add("hidden");
    }
});

const dropArea = document.getElementById("dropArea");
const photoInput = document.getElementById("photoInput");
const previewImage = document.getElementById("previewImage");

// CLICK ‚Üí OPEN CAMERA / GALLERY
dropArea.addEventListener("click", () => {
    photoInput.click();
});

// FILE SELECTED
photoInput.addEventListener("change", () => {
    handleFile(photoInput.files[0]);
});

// DRAG OVER
dropArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropArea.classList.add("border-blue-500");
});

// DRAG LEAVE
dropArea.addEventListener("dragleave", () => {
    dropArea.classList.remove("border-blue-500");
});

// DROP FILE
dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    dropArea.classList.remove("border-blue-500");

    const file = e.dataTransfer.files[0];
    handleFile(file);
});

// HANDLE FILE + PREVIEW
let selectedImageFile = null;

function handleFile(file) {
    if (!file || !file.type.startsWith("image/")) {
        alert("Please upload an image");
        return;
    }

    selectedImageFile = file; // üî• store file

    const reader = new FileReader();
    reader.onload = () => {
        previewImage.src = reader.result;
        previewImage.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
}

</script>

<script>
function compressImage(file, quality = 0.6, maxWidth = 1024) {
    return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = () => {
            img.src = reader.result;
        };

        img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            let width = img.width;
            let height = img.height;

            // Resize if too large
            if (width > maxWidth) {
                height = height * (maxWidth / width);
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
                (blob) => {
                    resolve(blob);
                },
                "image/jpeg",
                quality
            );
        };

        reader.readAsDataURL(file);
    });
}




async function uploadImageToImgBB(file) {
    const apiKey = "8df14bdc9edab7d115b488a955695e6c";

    // üî• COMPRESS IMAGE FIRST
    const compressedImage = await compressImage(file);

    const formData = new FormData();
    formData.append("image", compressedImage);

    const response = await fetch(
        `https://api.imgbb.com/1/upload?key=${apiKey}`,
        {
            method: "POST",
            body: formData
        }
    );

    const data = await response.json();
    return data.data.url;
}


async function submitReport() {
  let issueType = document.getElementById("issueType").value;

if (issueType === "others") {
    const otherText = document.getElementById("otherIssueText").value.trim();
    if (!otherText) {
        alert("Please specify the issue");
        return;
    }
    issueType = otherText;
}


    const location = document.getElementById("location").value;
    const description = document.getElementById("description").value;

    if (!issueType || !location || !description) {
        alert("Please fill all required fields");
        return;
    }

    let imageUrl = null;

    // üî• Upload image first (if exists)
    if (selectedImageFile) {
        imageUrl = await uploadImageToImgBB(selectedImageFile);
    }

    // üî• Send to backend
    fetch("/report", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            issueType,
            location,
            description,
            imageUrl
        })
    })
    .then(res => res.json())
    .then(() => {
        alert("‚úÖ Issue reported successfully");
        document.getElementById("reportForm").reset();
        previewImage.classList.add("hidden");
        selectedImageFile = null;
    });
}




// -------------------------
// LOAD MY REPORTS
// -------------------------
function loadMyReports() {
    fetch("/issues")
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById("myReports");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center">No reports yet</p>`;
            return;
        }

        data.reverse().forEach(issue => {
            let color = "bg-yellow-100 text-yellow-700";
            let label = "‚è±Ô∏è Pending";

            if (issue.status === "in-progress") {
                color = "bg-blue-100 text-blue-700";
                label = "üîÑ In Progress";
            }
            if (issue.status === "resolved") {
                color = "bg-green-100 text-green-700";
                label = "‚úÖ Resolved";
            }

            container.innerHTML += `
            <div class="flex items-center justify-between p-5 border rounded-lg">
                <div>
                    <h3 class="font-bold capitalize">${issue.issueType}</h3>
                    <p class="text-sm text-gray-600">${issue.location}</p>
                    <p class="text-xs text-gray-400">
                        ${new Date(issue.createdAt).toDateString()}
                    </p>
                </div>
                <span class="px-4 py-2 rounded-full text-sm font-medium ${color}">
                    ${label}
                </span>
            </div>`;
        });
    });
}

// -------------------------


// INITIAL LOAD
loadMyReports();                  // initial load
setInterval(loadMyReports, 5000);  // auto refresh every 5 seconds

</script>
<script>
function logout() {
    window.location.href = "login.html";
}
</script>



</body>
</html>