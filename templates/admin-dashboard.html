<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CityPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen">

<!-- IMAGE PREVIEW MODAL -->
<div id="imageModal"
     class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded-xl relative w-96 h-96 flex items-center justify-center">
        <button onclick="closeImageModal()"
                class="absolute top-2 right-2 text-xl font-bold text-gray-600 hover:text-red-600">
            ‚úñ
        </button>
        <img id="modalImage" class="max-w-full max-h-full object-contain rounded-lg">
    </div>
</div>

<!-- NAVBAR -->
<nav class="bg-gray-100 fixed w-full top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
        <div class="flex items-center space-x-3 cursor-pointer" onclick="window.location.href='index.html'">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                <span class="text-white text-xl">üìç</span>
            </div>
            <span class="text-2xl font-bold">CityPulse</span>
        </div>
        <button onclick="logout()" class="bg-red-500 text-white px-5 py-2 rounded-lg">Logout</button>
    </div>
</nav>

<!-- CONTENT -->
<div class="pt-28 px-4">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold mb-8">Admin Dashboard</h1>

        <div class="bg-white rounded-2xl shadow overflow-hidden">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold">All Complaints</h2>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                   <thead class="bg-gray-50">
<tr>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Photo</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Type</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Location</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Description</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Status</th>
    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Action</th>
</tr>
</thead>

                    <tbody id="adminIssuesTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAITsuAE_mdaB00MDUK1O6LEwASk-iSAf0",
  authDomain: "citypulse-b6c5e.firebaseapp.com",
  projectId: "citypulse-b6c5e",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});
</script>


<script>

function loadAdminIssues() {
    fetch("http://127.0.0.1:5000/issues")
        .then(res => res.json())
        .then(data => {
            const table = document.getElementById("adminIssuesTable");
            table.innerHTML = "";

            if (!data || data.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-gray-500 py-6">
                            No issues found
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(issue => {

                let imageCell = `
                    <div class="w-16 h-16 flex items-center justify-center
                                border rounded-lg text-gray-400 text-xs">
                        No Image
                    </div>
                `;

                if (issue.imageUrl && issue.imageUrl.trim() !== "") {
                    imageCell = `
                        <img src="${issue.imageUrl}"
                             class="w-16 h-16 object-cover rounded-lg border cursor-pointer"
                             onclick="openImageModal('${issue.imageUrl}')">
                    `;
                }

                table.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    
                    <!-- PHOTO -->
                    <td class="px-6 py-4">${imageCell}</td>

                    <!-- ISSUE TYPE -->
                    <td class="px-6 py-4 capitalize font-medium">
                        ${issue.issueType}
                    </td>

                    <!-- LOCATION -->
                    <td class="px-6 py-4 text-gray-600">
                        ${issue.location}
                    </td>

                    <!-- DESCRIPTION -->
                    <td class="px-6 py-4 text-gray-600 max-w-xs break-words">
                        ${issue.description || "No description"}
                    </td>

                    <!-- STATUS -->
                    <td class="px-6 py-4">
                        <select id="status-${issue.id}" class="px-3 py-1 border rounded-lg">
                            <option value="pending" ${issue.status==="pending"?"selected":""}>Pending</option>
                            <option value="in-progress" ${issue.status==="in-progress"?"selected":""}>In Progress</option>
                            <option value="resolved" ${issue.status==="resolved"?"selected":""}>Resolved</option>
                        </select>
                    </td>

                    <!-- ACTION -->
                    <td class="px-6 py-4">
                        <button onclick="updateStatus('${issue.id}')"
                                class="bg-blue-600 text-white px-4 py-2 rounded">
                            Update
                        </button>
                    </td>
                </tr>`;
            });
        });
}


function updateStatus(issueId) {

    const status = document.getElementById("status-" + issueId).value;

    console.log("SENDING UPDATE:", issueId, status);

    fetch(`http://127.0.0.1:5000/update/${issueId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ status: status })
    })
    .then(res => res.json())
    .then(data => {
        alert("‚úÖ Status Updated");
        loadAdminIssues(); // refresh table
    })
    .catch(err => {
        console.error("UPDATE ERROR:", err);
        alert("‚ùå Update failed");
    });
}

function openImageModal(url) {
    document.getElementById("modalImage").src = url;
    document.getElementById("imageModal").classList.remove("hidden");
}

function closeImageModal() {
    document.getElementById("modalImage").src = "";
    document.getElementById("imageModal").classList.add("hidden");
}




loadAdminIssues();               // initial load
setInterval(loadAdminIssues, 5000); // auto refresh every 5 seconds

</script>
<script>

function logout() {
    window.location.href = "login.html";
}



</script>

</body>
</html>
